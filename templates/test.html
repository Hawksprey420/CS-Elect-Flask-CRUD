<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Enrollment API - Test UI</title>
	</head>
	<body>
		<h1>Enrollment API - Test UI</h1>

		<p>
			This page is served by the running Flask app. If you can see this, your <strong>app.py</strong> is already running.
		</p>

		<h2>Warnings</h2>
		<ul>
			<li><strong>Local only:</strong> Admin buttons below only work from localhost.</li>
			<li><strong>Danger:</strong> “Insert Data” writes into your MySQL database.</li>
			<li><strong>Security:</strong> Student endpoints require a valid JWT (Bearer token).</li>
		</ul>

		<hr />

		<h2>Admin Tools (Insert Data / Run Tests)</h2>
		<p>
			These actions require <strong>Basic Auth</strong> using your configured username/password (see <strong>config/config.py</strong>).
		</p>

		<label>
			<input id="confirmDanger" type="checkbox" />
			I understand these actions can modify the database.
		</label>

		<div>
			<p>
				<label>Admin Username: <input id="adminUser" type="text" value="admin" /></label>
				<label>Admin Password: <input id="adminPass" type="password" value="password" /></label>
			</p>

			<button id="btnSeed" disabled>Insert / Generate Data (tests/insert_data.py)</button>
			<button id="btnTests" disabled>Run API Tests (tests/test_api.py)</button>
		</div>

		<pre id="adminOutput"></pre>

		<hr />

		<h2>JWT Login</h2>
		<p>
			Click “Login” to request a JWT token from <strong>/login</strong>, then use it for CRUD/search calls below.
		</p>
		<p>
			<button id="btnLogin">Login (POST /login)</button>
			<span id="loginStatus"></span>
		</p>

		<p>
			<label>JWT Token: <input id="jwtToken" type="text" size="80" placeholder="Bearer token will appear here" /></label>
		</p>

		<hr />

		<h2>Manual Student Insert (Create)</h2>
		<p>This uses <strong>POST /students</strong> and requires JWT.</p>

		<p>
			<label>student_id: <input id="studentId" type="number" value="999" /></label>
			<label>student_name: <input id="studentName" type="text" value="UI Student" /></label>
			<label>year_level: <input id="yearLevel" type="number" value="1" /></label>
			<label>gpa: <input id="gpa" type="number" step="0.01" value="3.50" /></label>
			<label>dept_id: <input id="deptId" type="number" value="1" /></label>
			<button id="btnCreateStudent">Create Student</button>
		</p>

		<hr />

		<h2>Search Students (Read)</h2>
		<p>
			Uses <strong>GET /students?search=</strong> and supports <strong>?format=json|xml</strong>.
		</p>
		<p>
			<label>Search: <input id="searchQuery" type="text" value="" placeholder="name contains..." /></label>
			<label>
				Format:
				<select id="formatSelect">
					<option value="json" selected>json</option>
					<option value="xml">xml</option>
				</select>
			</label>
			<button id="btnSearch">Search</button>
		</p>

		<h2>Get Student by ID (Read)</h2>
		<p>
			<label>ID: <input id="getStudentId" type="number" value="999" /></label>
			<button id="btnGetStudent">Get Student</button>
		</p>

		<h2>Output</h2>
		<pre id="output"></pre>

		<script>
			function basicAuthHeader(username, password) {
				const encoded = btoa(`${username}:${password}`);
				return `Basic ${encoded}`;
			}

			function bearerAuthHeader(token) {
				const trimmed = (token || "").trim();
				return trimmed.startsWith("Bearer ") ? trimmed : `Bearer ${trimmed}`;
			}

			function setText(id, text) {
				document.getElementById(id).textContent = text;
			}

			function enableAdminButtons() {
				const ok = document.getElementById('confirmDanger').checked;
				document.getElementById('btnSeed').disabled = !ok;
				document.getElementById('btnTests').disabled = !ok;
			}

			document.getElementById('confirmDanger').addEventListener('change', enableAdminButtons);
			enableAdminButtons();

			document.getElementById('btnSeed').addEventListener('click', async () => {
				setText('adminOutput', 'Running insert_data.py...');
				const u = document.getElementById('adminUser').value;
				const p = document.getElementById('adminPass').value;
				const res = await fetch('/admin/seed', {
					method: 'POST',
					headers: { 'Authorization': basicAuthHeader(u, p) }
				});
				const body = await res.json().catch(() => ({ ok: false, output: 'Non-JSON response' }));
				setText('adminOutput', `HTTP ${res.status}\nOK: ${body.ok}\nReturn Code: ${body.returncode}\n\n${body.output}`);
			});

			document.getElementById('btnTests').addEventListener('click', async () => {
				setText('adminOutput', 'Running test_api.py...');
				const u = document.getElementById('adminUser').value;
				const p = document.getElementById('adminPass').value;
				const res = await fetch('/admin/run-tests', {
					method: 'POST',
					headers: { 'Authorization': basicAuthHeader(u, p) }
				});
				const body = await res.json().catch(() => ({ ok: false, output: 'Non-JSON response' }));
				setText('adminOutput', `HTTP ${res.status}\nOK: ${body.ok}\nReturn Code: ${body.returncode}\n\n${body.output}`);
			});

			document.getElementById('btnLogin').addEventListener('click', async () => {
				setText('loginStatus', 'Logging in...');
				const u = document.getElementById('adminUser').value;
				const p = document.getElementById('adminPass').value;
				const res = await fetch('/login', {
					method: 'POST',
					headers: { 'Authorization': basicAuthHeader(u, p) }
				});

				if (!res.ok) {
					setText('loginStatus', `Login failed (HTTP ${res.status})`);
					return;
				}
				const data = await res.json();
				document.getElementById('jwtToken').value = data.token;
				setText('loginStatus', 'Login OK: token stored');
			});

			document.getElementById('btnCreateStudent').addEventListener('click', async () => {
				const token = document.getElementById('jwtToken').value;
				const payload = {
					student_id: Number(document.getElementById('studentId').value),
					student_name: document.getElementById('studentName').value,
					year_level: Number(document.getElementById('yearLevel').value),
					gpa: Number(document.getElementById('gpa').value),
					dept_id: Number(document.getElementById('deptId').value)
				};

				const res = await fetch('/students', {
					method: 'POST',
					headers: {
						'Authorization': bearerAuthHeader(token),
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(payload)
				});
				const text = await res.text();
				setText('output', `POST /students\nHTTP ${res.status}\n\n${text}`);
			});

			document.getElementById('btnSearch').addEventListener('click', async () => {
				const token = document.getElementById('jwtToken').value;
				const query = encodeURIComponent(document.getElementById('searchQuery').value || '');
				const fmt = encodeURIComponent(document.getElementById('formatSelect').value);
				const url = `/students?search=${query}&format=${fmt}`;

				const res = await fetch(url, {
					method: 'GET',
					headers: { 'Authorization': bearerAuthHeader(token) }
				});

				const text = await res.text();
				setText('output', `GET ${url}\nHTTP ${res.status}\n\n${text}`);
			});

			document.getElementById('btnGetStudent').addEventListener('click', async () => {
				const token = document.getElementById('jwtToken').value;
				const studentId = Number(document.getElementById('getStudentId').value);
				const fmt = encodeURIComponent(document.getElementById('formatSelect').value);
				const url = `/students/${studentId}?format=${fmt}`;

				const res = await fetch(url, {
					method: 'GET',
					headers: { 'Authorization': bearerAuthHeader(token) }
				});
				const text = await res.text();
				setText('output', `GET ${url}\nHTTP ${res.status}\n\n${text}`);
			});
		</script>
	</body>
</html>
